/*!
App.net timeline fetcher (c) 2013 Brandon Mathis, @imathis // MIT License
Version: 1.2
Source: https://github.com/imathis/adn-timeline/
*/
(function(){var e,t,n=[].slice;e={defaults:{el:".adn-timeline",count:4,replies:false,reposts:false,cookie:"adn-timeline",avatars:false},init:function(e){var t,n,r,i=this;if(e==null){e=[{}]}if(!(e instanceof Array)){e=[e]}for(n=0,r=e.length;n<r;n++){t=e[n];jQuery(t.el||this.defaults.el).each(function(e,n){var r,s,o,u;n=jQuery(n);s=t.render||i.render;r=t.callback||function(){};t=jQuery.extend({},i.defaults,t,n.data());t.el=n;t.username=(o=t.username)!=null?o.replace("@",""):void 0;t.hashtag=(u=t.hashtag)!=null?u.replace("#",""):void 0;if(!(t.username!=null||t.hashtag!=null)){return console.error("You need to provide an App.net username or hashtag")}if(t.cookie===i.defaults.cookie){t.cookie=t.cookie+("-"+(t.username||t.hashtag))}return i.timeline(i.helpers).fetch(s,r,t)})}return this},cascadeOptions:function(){var e,t,r,i;t=1<=arguments.length?n.call(arguments,0):[];for(r=0,i=t.length;r<i;r++){e=t[r];if(e!=null&&e===e){return e;break}}},render:function(e,t){var n,r,i,s,o;n=e.el;i="<ul id='adn-timeline-"+(e.username||e.hashtag)+"'>";for(s=0,o=t.length;s<o;s++){r=t[s];i+="<li><figure class='adn-post'>";if(r.author.avatar){i+="<a href='"+r.author.url+"' class='adn-author-avatar-link'>";if(r.author.avatar){i+="<img alt='@"+r.author.username+"'s avatar on App.net' class='adn-author-avatar' width=48 src='"+r.author.avatar+"'>"}i+="</a>"}i+="<figcaption>";if(r.author.unique){i+="<p>";if(r.repost){i+="<span class='adn-repost-marker'>>></span> "}i+="<a href='"+r.author.url+"' class='adn-author-url' rel=author>";i+="<strong class='adn-author-name'>"+r.author.name+"</strong> <span class='adn-author-username'>@"+r.author.username+"</span>";i+="</a></p>"}i+="<a href='"+r.url+"' class='adn-post-url'><time datetime='"+r.date+"'>"+r.display_date+"</time></a>";i+="</figcaption>";i+="<blockquote><p>";i+=r.text;i+="</p></blockquote>";i+="</figure></li>"}i+="</ul>";return n.append(i)},timeline:function(e){return{data:[],fetch:function(t,n,r){var i,s,o,u=this;if(jQuery.cookie&&r.cookie&&(s=jQuery.cookie(r.cookie))){i=JSON.parse(s);if(i.length!==r.count){jQuery.removeCookie(r.cookie);return this.fetch(t,n,r)}else{t(r,i);return n(i)}}else{o="https://alpha-api.app.net/stream/0/";if(r.username){o+="users/@"+r.username+"/posts?include_deleted=0"}if(r.hashtag){o+="posts/tag/"+r.hashtag+"?include_deleted=0"}if(r.before_id){o+="&before_id="+r.before_id}if(!r.replies){o+="&include_directed_posts=0"}o+="&callback=?";return jQuery.ajax({url:o,dataType:"jsonp",error:function(e){console.error("Error fetching App.net timeline");return console.error(e)},success:function(s){var o,a,f,l;if(!r.reposts){i=[];l=s.data;for(a=0,f=l.length;a<f;a++){o=l[a];if(!o.repost_of){i.push(o)}}s.data=i}u.data=u.data.concat(s.data);if(u.data.length<r.count){r.before_id=s.meta.min_id;return u.fetch(t,n,r)}else{u.data=function(){var t,n,i,s;i=this.data.slice(0,r.count);s=[];for(t=0,n=i.length;t<n;t++){o=i[t];s.push(e.postData(o,r))}return s}.call(u);if(jQuery.cookie&&r.cookie){jQuery.cookie(r.cookie,JSON.stringify(u.data,{path:"/"}))}t(r,u.data);return n(u.data)}}})}}}},helpers:{trimUrl:function(e){var t,n,r,i,s,o,u;r=[];t=40;e=e.replace(/(https?:\/\/)/i,"");u=e.split("/");for(s=0,o=u.length;s<o;s++){n=u[s];if(!(r.concat(n).join("/").length<t)){break}r.push(n)}i=r.join("/");if(e.length-i.length>15){i=e.slice(0,t)}if(i.length<e.length){return i+"â€¦"}else{return i}},trimDisplayUrls:function(e){var t=this;return e.replace(/>\s*(https?:\/\/.+?)\s*</gi,function(e,n){return">"+t.trimUrl(n)+"<"})},linkify:function(e){var t,n,r,i,s,o,u,a,f;r=this.trimDisplayUrls(e.html);a=e.entities.mentions;for(i=0,o=a.length;i<o;i++){n=a[i];r=r.replace(new RegExp("@("+n.name+")","gi"),"<a class='adn-username' href='https://alpha.app.net/$1'>@$1</a>")}f=e.entities.hashtags;for(s=0,u=f.length;s<u;s++){t=f[s];r=r.replace(new RegExp("#("+t.name+")","gi"),"<a class='adn-hashtag' href='https://alpha.app.net/hashtags/$1'>#$1</a>")}return r},postData:function(e,t){var n,r;r=!!e.repost_of;if(r){e=e.repost_of}if(t.avatars){n=e.user.avatar_image.url}return{repost:r,url:e.canonical_url,date:e.created_at,display_date:this.timeago(e.created_at),author:{username:e.user.username,name:e.user.name,url:e.user.canonical_url,avatar:n,unique:!!(t.reposts||t.hashtag)},text:this.linkify(e)}},timeago:function(e){var t,n,r,i,s,o;i={just_now:"now",minute_ago:"1m",minutes_ago:"m",hour_ago:"1h",hours_ago:"h",yesterday:"1d",days_ago:"d",last_week:"1w",weeks_ago:"w"};s=((new Date).getTime()-(new Date(e)).getTime())/1e3;r=Math.floor(s/60);n=Math.floor(s/3600);t=Math.floor(s/86400);o=Math.floor(t/7);if(isNaN(s)||t<0){return"#"}if(t===0){if(s<60){return i.just_now}else if(s<120){return i.minute_ago}else if(s<3600){return r+i.minutes_ago}else if(s<7200){return i.hour_ago}else{return n+i.hours_ago}}else{if(t===1){return i.yesterday}else if(t<7){return t+i.days_ago}else if(t===7){return i.last_week}else{return o+i.weeks_ago}}}}};if(typeof t!=="undefined"&&t!==null){if(typeof module!=="undefined"&&module!==null&&module.exports){t=module.exports=e}else{t.AdnTimeline=e}}else{this.AdnTimeline=e}}).call(this)

